name: Build Linux DEB Package

on:
    workflow_dispatch:
        inputs:
            create_release:
                description: "Create GitHub Release"
                required: false
                default: false
                type: boolean
            version:
                description: "Version number (e.g., 1.0.0) - required if creating release"
                required: false
                default: ""
                type: string

jobs:
    build-deb:
        runs-on: ubuntu-latest
        name: Build Linux DEB Package
        permissions:
            contents: write  # Required for creating tags and releases

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch all history for tagging
                  persist-credentials: true

            - name: Setup Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              run: |
                  echo "Installing Node.js dependencies..."
                  npm install

            - name: Install pkg globally
              run: |
                  echo "Installing @yao-pkg/pkg for Node 20 support..."
                  npm install -g @yao-pkg/pkg

            - name: Build Linux executable
              run: |
                  echo "Building Linux x64 executable..."
                  pkg . --targets node20-linux-x64 --output ./dist/direct-print-linux
                  chmod +x ./dist/direct-print-linux

                  echo "Verifying executable..."
                  ls -lh ./dist/direct-print-linux
                  file ./dist/direct-print-linux

                  # Remove extended attributes if any (similar to macOS xattr)
                  echo "Removing extended attributes..."
                  setfattr -h -x user.pax.flags ./dist/direct-print-linux 2>/dev/null || true

            - name: Install DEB packaging tools
              run: |
                  echo "Installing dpkg-deb and fakeroot..."
                  sudo apt-get update
                  sudo apt-get install -y dpkg-dev fakeroot

            - name: Create DEB package structure
              run: |
                  echo "Creating DEB package directory structure..."

                  # Create package directory
                  mkdir -p direct-print-server_1.0.0_amd64/DEBIAN
                  mkdir -p direct-print-server_1.0.0_amd64/usr/local/bin
                  mkdir -p direct-print-server_1.0.0_amd64/usr/local/share/direct-print-server
                  mkdir -p direct-print-server_1.0.0_amd64/etc/systemd/system
                  mkdir -p direct-print-server_1.0.0_amd64/usr/share/applications
                  mkdir -p direct-print-server_1.0.0_amd64/usr/share/doc/direct-print-server

                  echo "‚úÖ DEB structure created"

            - name: Copy executable and assets
              run: |
                  echo "Copying application files..."

                  # Copy executable
                  cp dist/direct-print-linux direct-print-server_1.0.0_amd64/usr/local/bin/direct-print-server
                  chmod +x direct-print-server_1.0.0_amd64/usr/local/bin/direct-print-server

                  # Copy public assets
                  if [ -d "public" ]; then
                    cp -r public/* direct-print-server_1.0.0_amd64/usr/local/share/direct-print-server/
                  fi

                  echo "‚úÖ Files copied"

            - name: Create systemd service file
              run: |
                  cat > direct-print-server_1.0.0_amd64/etc/systemd/system/direct-print-server.service << 'EOF'
                  [Unit]
                  Description=Direct Print Server - Thermal Printer Service
                  After=network.target cups.service

                  [Service]
                  Type=simple
                  User=root
                  ExecStart=/usr/local/bin/direct-print-server
                  Restart=always
                  RestartSec=10
                  StandardOutput=journal
                  StandardError=journal

                  [Install]
                  WantedBy=multi-user.target
                  EOF

                  echo "‚úÖ Systemd service file created"

            - name: Create desktop entry
              run: |
                  cat > direct-print-server_1.0.0_amd64/usr/share/applications/direct-print-server.desktop << 'EOF'
                  [Desktop Entry]
                  Version=1.0
                  Type=Application
                  Name=Direct Print Server
                  Comment=Thermal Printer Service for POS Systems
                  Exec=xdg-open http://localhost:4000
                  Icon=printer
                  Terminal=false
                  Categories=Office;Printing;
                  Keywords=printer;thermal;pos;receipt;
                  EOF

                  echo "‚úÖ Desktop entry created"

            - name: Create control file
              run: |
                  cat > direct-print-server_1.0.0_amd64/DEBIAN/control << 'EOF'
                  Package: direct-print-server
                  Version: 1.0.0
                  Section: utils
                  Priority: optional
                  Architecture: amd64
                  Depends: libcups2
                  Maintainer: aiqbalsyah <noreply@github.com>
                  Description: Direct Print Server - Thermal Printer Service
                   Thermal printer service for Windows, Mac, and Linux.
                   Supports system printers and thermal receipt printers.
                   .
                   Features:
                    - Auto printer detection
                    - WebSocket real-time tracking
                    - ESC/POS command support
                    - Web-based management interface
                    - Systemd service integration
                  Homepage: https://github.com/aiqbalsyah/direct-print-utils-pos
                  EOF

                  echo "‚úÖ Control file created"

            - name: Create postinst script
              run: |
                  cat > direct-print-server_1.0.0_amd64/DEBIAN/postinst << 'EOF'
                  #!/bin/bash
                  set -e

                  echo "Setting up Direct Print Server..."

                  # Ensure executable has correct permissions
                  chmod +x /usr/local/bin/direct-print-server

                  # Remove extended attributes if any
                  setfattr -h -x user.pax.flags /usr/local/bin/direct-print-server 2>/dev/null || true

                  # Fix SELinux context if SELinux is enabled
                  if command -v restorecon > /dev/null && getenforce 2>/dev/null | grep -q "Enforcing"; then
                      echo "Setting SELinux context..."
                      restorecon -v /usr/local/bin/direct-print-server || true
                  fi

                  # Reload systemd
                  systemctl daemon-reload

                  # Enable service
                  systemctl enable direct-print-server.service

                  # Start service
                  systemctl start direct-print-server.service

                  # Wait for service to start
                  sleep 3

                  # Open browser to verify installation
                  if command -v xdg-open > /dev/null; then
                      xdg-open http://localhost:4000/index.html &
                  elif command -v gnome-open > /dev/null; then
                      gnome-open http://localhost:4000/index.html &
                  fi

                  echo "‚úÖ Direct Print Server installed successfully!"
                  echo "   Service started and enabled for auto-start"
                  echo "   Opening browser to verify installation..."
                  echo "   Access web interface at: http://localhost:4000"
                  echo ""
                  echo "Useful commands:"
                  echo "  - Check status: systemctl status direct-print-server"
                  echo "  - View logs: journalctl -u direct-print-server -f"
                  echo "  - Restart: systemctl restart direct-print-server"

                  exit 0
                  EOF

                  chmod +x direct-print-server_1.0.0_amd64/DEBIAN/postinst
                  echo "‚úÖ Post-install script created"

            - name: Create prerm script
              run: |
                  cat > direct-print-server_1.0.0_amd64/DEBIAN/prerm << 'EOF'
                  #!/bin/bash
                  set -e

                  echo "Stopping Direct Print Server..."

                  # Stop service
                  systemctl stop direct-print-server.service || true

                  # Disable service
                  systemctl disable direct-print-server.service || true

                  exit 0
                  EOF

                  chmod +x direct-print-server_1.0.0_amd64/DEBIAN/prerm
                  echo "‚úÖ Pre-remove script created"

            - name: Create postrm script
              run: |
                  cat > direct-print-server_1.0.0_amd64/DEBIAN/postrm << 'EOF'
                  #!/bin/bash
                  set -e

                  # Reload systemd
                  systemctl daemon-reload

                  echo "‚úÖ Direct Print Server removed successfully"

                  exit 0
                  EOF

                  chmod +x direct-print-server_1.0.0_amd64/DEBIAN/postrm
                  echo "‚úÖ Post-remove script created"

            - name: Create README documentation
              run: |
                  cat > direct-print-server_1.0.0_amd64/usr/share/doc/direct-print-server/README << 'EOF'
                  Direct Print Server - Thermal Printer Service
                  =============================================

                  Version: 1.0.0

                  INSTALLATION
                  ------------
                  sudo dpkg -i direct-print-server_1.0.0_amd64.deb

                  USAGE
                  -----
                  The service starts automatically after installation.
                  Access the web interface at: http://localhost:4000

                  SYSTEMD COMMANDS
                  ----------------
                  Start:   sudo systemctl start direct-print-server
                  Stop:    sudo systemctl stop direct-print-server
                  Restart: sudo systemctl restart direct-print-server
                  Status:  sudo systemctl status direct-print-server
                  Logs:    sudo journalctl -u direct-print-server -f

                  UNINSTALL
                  ---------
                  sudo dpkg -r direct-print-server

                  REQUIREMENTS
                  ------------
                  - Ubuntu 20.04+ / Debian 10+
                  - CUPS printing system (usually pre-installed)
                  - Printer configured in system settings

                  SUPPORT
                  -------
                  GitHub: https://github.com/aiqbalsyah/direct-print-utils-pos
                  EOF

                  echo "‚úÖ README created"

            - name: Set proper permissions
              run: |
                  echo "Setting file permissions..."

                  # Set ownership (will be root after install)
                  sudo chown -R root:root direct-print-server_1.0.0_amd64

                  # Set permissions
                  sudo chmod -R 755 direct-print-server_1.0.0_amd64/usr
                  sudo chmod -R 755 direct-print-server_1.0.0_amd64/etc
                  sudo chmod 644 direct-print-server_1.0.0_amd64/etc/systemd/system/direct-print-server.service
                  sudo chmod 755 direct-print-server_1.0.0_amd64/DEBIAN
                  sudo chmod 644 direct-print-server_1.0.0_amd64/DEBIAN/control

                  echo "‚úÖ Permissions set"

            - name: Build DEB package
              run: |
                  echo "Building DEB package..."

                  dpkg-deb --build direct-print-server_1.0.0_amd64

                  echo "Verifying DEB package..."
                  ls -lh direct-print-server_1.0.0_amd64.deb
                  dpkg-deb --info direct-print-server_1.0.0_amd64.deb
                  dpkg-deb --contents direct-print-server_1.0.0_amd64.deb

                  echo "‚úÖ DEB package built successfully!"

            - name: Test DEB package
              run: |
                  echo "Testing DEB package installation (dry-run)..."
                  sudo dpkg --dry-run -i direct-print-server_1.0.0_amd64.deb || echo "Dry-run test completed"

            - name: Create release package
              run: |
                  mkdir -p release

                  # Create filename with version
                  VERSION="${{ inputs.version }}"
                  if [ -z "$VERSION" ]; then
                      VERSION="latest"
                  fi

                  cp direct-print-server_1.0.0_amd64.deb "release/Direct-Print-Server-v${VERSION}-linux-amd64.deb"

                  # Create installation guide
                  cat > release/INSTALL.txt << 'EOF'
                  ====================================================
                    Direct Print Server - Linux DEB Package
                  ====================================================

                  INSTALLATION
                  ------------
                  sudo dpkg -i direct-print-server_1.0.0_amd64.deb

                  The service will automatically start after installation.

                  VERIFY INSTALLATION
                  -------------------
                  1. Check service status:
                     systemctl status direct-print-server

                  2. Open web interface:
                     http://localhost:4000

                  3. View logs:
                     journalctl -u direct-print-server -f

                  REQUIREMENTS
                  ------------
                  - Ubuntu 20.04+ / Debian 10+ / Linux Mint 20+
                  - CUPS printing system
                  - Printer configured in system

                  UNINSTALL
                  ---------
                  sudo dpkg -r direct-print-server

                  TROUBLESHOOTING
                  ---------------
                  Permission denied error:
                  1. Check executable permissions: ls -l /usr/local/bin/direct-print-server
                  2. Fix permissions: sudo chmod +x /usr/local/bin/direct-print-server
                  3. Restart service: sudo systemctl restart direct-print-server

                  SELinux issues (Fedora/RHEL/CentOS):
                  1. Check SELinux status: getenforce
                  2. Fix context: sudo restorecon -v /usr/local/bin/direct-print-server
                  3. Or temporarily disable: sudo setenforce 0

                  If service won't start:
                  1. Check logs: journalctl -u direct-print-server -xe
                  2. Verify port 4000 is available: lsof -i:4000
                  3. Check printer setup: lpstat -p -d

                  SUPPORT
                  -------
                  GitHub: https://github.com/aiqbalsyah/direct-print-utils-pos
                  Issues: https://github.com/aiqbalsyah/direct-print-utils-pos/issues
                  EOF

                  echo "‚úÖ Release package created"

            - name: Upload DEB artifact
              uses: actions/upload-artifact@v4
              with:
                  name: direct-print-linux-deb-${{ github.sha }}
                  path: release/
                  retention-days: 90

            - name: Create and push git tag
              if: ${{ inputs.create_release == true && inputs.version != '' }}
              run: |
                  echo "Checking if tag v${{ inputs.version }} exists..."

                  if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
                      echo "‚úÖ Tag v${{ inputs.version }} already exists, skipping tag creation"
                  else
                      echo "Creating git tag v${{ inputs.version }}"
                      git config user.name "github-actions[bot]"
                      git config user.email "github-actions[bot]@users.noreply.github.com"
                      git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
                      git push origin "v${{ inputs.version }}"
                      echo "‚úÖ Tag v${{ inputs.version }} created and pushed"
                  fi

            - name: Create Release
              if: ${{ inputs.create_release == true && inputs.version != '' }}
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      release/Direct-Print-Server-v${{ inputs.version }}-linux-amd64.deb
                      release/INSTALL.txt
                  name: Direct Print Server v${{ inputs.version }}
                  tag_name: v${{ inputs.version }}
                  body: |
                      ## üêß Direct Print Server - Linux DEB Package

                      ### üì¶ Professional Debian/Ubuntu Package

                      **Features:**
                      - ‚úÖ **Native DEB Package** - Standard Linux package format
                      - ‚úÖ **Systemd Integration** - Auto-start on boot
                      - ‚úÖ **CUPS Support** - Works with any CUPS printer
                      - ‚úÖ **Easy Management** - systemctl commands
                      - ‚úÖ **Clean Uninstall** - Complete removal with dpkg

                      ### üöÄ Quick Installation

                      ```bash
                      # Download the DEB package
                      wget https://github.com/aiqbalsyah/direct-print-utils-pos/releases/download/v${{ inputs.version }}/Direct-Print-Server-v${{ inputs.version }}-linux-amd64.deb

                      # Install
                      sudo dpkg -i Direct-Print-Server-v${{ inputs.version }}-linux-amd64.deb

                      # Verify
                      systemctl status direct-print-server

                      # Open web interface
                      xdg-open http://localhost:4000
                      ```

                      ### üíª Supported Distributions

                      - Ubuntu 20.04 LTS (Focal)
                      - Ubuntu 22.04 LTS (Jammy)
                      - Ubuntu 24.04 LTS (Noble)
                      - Debian 10 (Buster)
                      - Debian 11 (Bullseye)
                      - Debian 12 (Bookworm)
                      - Linux Mint 20+
                      - Pop!_OS 20.04+

                      ### üéØ Package Contents

                      - `/usr/local/bin/direct-print-server` - Main executable
                      - `/etc/systemd/system/direct-print-server.service` - Systemd service
                      - `/usr/share/applications/direct-print-server.desktop` - Desktop entry
                      - `/usr/share/doc/direct-print-server/` - Documentation

                      ### üîß Management Commands

                      ```bash
                      # Service control
                      sudo systemctl start direct-print-server
                      sudo systemctl stop direct-print-server
                      sudo systemctl restart direct-print-server
                      sudo systemctl status direct-print-server

                      # View logs
                      sudo journalctl -u direct-print-server -f

                      # Uninstall
                      sudo dpkg -r direct-print-server
                      ```

                      ### üìã Requirements

                      - CUPS printing system (usually pre-installed)
                      - Printer configured in system settings
                      - Port 4000 available

                      ### ‚ö†Ô∏è Troubleshooting

                      **Permission Denied Error:**
                      ```bash
                      sudo chmod +x /usr/local/bin/direct-print-server
                      sudo systemctl restart direct-print-server
                      ```

                      **SELinux Issues (Fedora/RHEL/CentOS):**
                      ```bash
                      # Fix SELinux context
                      sudo restorecon -v /usr/local/bin/direct-print-server
                      sudo systemctl restart direct-print-server
                      ```

                      The postinst script handles these automatically, but manual fix available if needed.

                      Perfect for Linux servers and desktop deployments!
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
