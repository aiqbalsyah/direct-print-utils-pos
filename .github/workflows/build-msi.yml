name: Build Windows MSI Installer

on:
    workflow_dispatch:
        inputs:
            create_release:
                description: "Create GitHub Release"
                required: false
                default: false
                type: boolean
            version:
                description: "Version number (e.g., 1.0.0) - required if creating release"
                required: false
                default: ""
                type: string

jobs:
    build-msi:
        runs-on: windows-latest
        name: Build Windows MSI Installer
        permissions:
            contents: write  # Required for creating tags and releases

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch all history for tagging
                  persist-credentials: true

            - name: Setup Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Setup WiX Toolset
              run: |
                  echo "Installing WiX Toolset..."
                  choco install wixtoolset -y
                  echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $GITHUB_PATH
              shell: pwsh

            - name: Install dependencies
              run: |
                  echo "Installing dependencies..."
                  npm install
              shell: cmd

            - name: Install pkg globally
              run: |
                  echo "Installing @yao-pkg/pkg for Node 20 support..."
                  npm install -g @yao-pkg/pkg
              shell: cmd

            - name: Build using existing script
              run: |
                  echo "Building with build-complete.bat..."
                  set CI=true
                  call build-complete.bat
              shell: cmd

            - name: Debug build output
              run: |
                  echo "Checking what was built..."
                  echo "Contents of dist folder:"
                  dir dist
                  echo "‚úÖ Found direct-print-win.exe - build successful!"

                  echo "Checking scripts folder structure:"
                  if exist "scripts" (
                    dir scripts
                    if exist "scripts\windows" (
                      echo "‚úÖ scripts\windows exists"
                      dir scripts\windows
                    ) else (
                      echo "‚ùå scripts\windows not found"
                    )
                  ) else (
                    echo "‚ùå scripts folder not found"
                  )
              shell: cmd

            - name: Prepare MSI structure
              run: |
                  echo "Preparing files for MSI creation..."
                  if not exist "installer" mkdir installer
                  if not exist "installer\bin" mkdir installer\bin
                  if not exist "installer\scripts" mkdir installer\scripts
                  if not exist "installer\resources" mkdir installer\resources

                  echo "Copying executable..."
                  copy "dist\direct-print-win.exe" "installer\bin\DirectPrintServer.exe"
                  if %ERRORLEVEL% NEQ 0 (
                    echo "‚ùå Failed to copy executable"
                    exit /b 1
                  )
                  echo "‚úÖ Executable copied successfully"

                  echo "Copying logo, icon, and banner images..."
                  if exist "public\logo.bmp" (
                    copy "public\logo.bmp" "installer\resources\logo.bmp"
                    if %ERRORLEVEL% EQU 0 (
                      echo "‚úÖ Logo BMP copied successfully"
                    ) else (
                      echo "‚ö†Ô∏è Logo BMP copy failed, continuing..."
                    )
                  ) else (
                    echo "‚ö†Ô∏è Logo.bmp not found, continuing..."
                  )

                  if exist "public\logo.ico" (
                    copy "public\logo.ico" "installer\resources\app.ico"
                    if %ERRORLEVEL% EQU 0 (
                      echo "‚úÖ Application icon (ICO) copied successfully"
                    ) else (
                      echo "‚ö†Ô∏è Icon copy failed, continuing without icon..."
                    )
                  ) else (
                    echo "‚ö†Ô∏è Logo.ico not found, continuing without icon..."
                  )

                  if exist "public\banner.bmp" (
                    copy "public\banner.bmp" "installer\resources\banner.bmp"
                    if %ERRORLEVEL% EQU 0 (
                      echo "‚úÖ Banner image copied successfully"
                    ) else (
                      echo "‚ö†Ô∏è Banner copy failed, continuing without banner..."
                    )
                  ) else (
                    echo "‚ö†Ô∏è Banner.bmp not found, continuing without banner..."
                  )

                  echo "Copying scripts..."
                  if exist "scripts\windows" (
                    xcopy /E /I /Y "scripts\windows" "installer\scripts"
                    if %ERRORLEVEL% NEQ 0 (
                      echo "‚ùå Failed to copy scripts"
                      exit /b 1
                    )
                    echo "‚úÖ Scripts copied successfully"
                  ) else (
                    echo "‚ö†Ô∏è No scripts\windows folder found, continuing..."
                  )

                  echo "Verifying installer structure:"
                  dir installer\bin
                  if exist "installer\scripts" dir installer\scripts
                  if exist "installer\resources" dir installer\resources

                  echo "‚úÖ MSI structure prepared"
              shell: cmd

            - name: Create WiX configuration
              run: |
                  $wixContent = @'
                  <?xml version="1.0" encoding="UTF-8"?>
                  <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
                    <Product Id="*" Name="Direct Print Server" Language="1033" Version="1.0.0"
                             Manufacturer="Direct Print Solutions" UpgradeCode="12345678-1234-5678-9012-123456789012">

                      <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" InstallPrivileges="elevated"
                               Comments="Administrator privileges required for Windows Service installation"
                               Description="Direct Print Server - Requires Administrator" />
                      <MajorUpgrade DowngradeErrorMessage="A newer version is already installed."
                                    AllowSameVersionUpgrades="yes" />
                      <MediaTemplate EmbedCab="yes" />

                      <!-- Add application icon -->
                      <Icon Id="AppIcon" SourceFile="installer\resources\app.ico" />
                      <Property Id="ARPPRODUCTICON" Value="AppIcon" />

                      <Feature Id="ProductFeature" Title="Direct Print Server" Level="1">
                        <ComponentGroupRef Id="ProductComponents" />
                        <ComponentGroupRef Id="StartMenuComponents" />
                        <ComponentRef Id="RegistryEntries" />
                      </Feature>

                      <Directory Id="TARGETDIR" Name="SourceDir">
                        <Directory Id="ProgramFilesFolder">
                          <Directory Id="INSTALLFOLDER" Name="DirectPrintServer" />
                        </Directory>
                        <Directory Id="ProgramMenuFolder">
                          <Directory Id="ApplicationProgramsFolder" Name="Direct Print Server" />
                        </Directory>
                      </Directory>

                      <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
                        <Component Id="MainExecutable" Guid="11111111-1111-1111-1111-111111111111">
                          <File Id="DirectPrintServerEXE" Source="installer\bin\DirectPrintServer.exe" KeyPath="yes" />
                        </Component>

                        <Component Id="ServiceScripts" Guid="22222222-2222-2222-2222-222222222222">
                          <File Id="InstallServiceJS" Source="installer\scripts\service\install-service.js" />
                          <File Id="UninstallServiceJS" Source="installer\scripts\service\uninstall-service.js" />
                        </Component>

                        <Component Id="StartupScripts" Guid="33333333-3333-3333-3333-333333333333">
                          <File Id="StartupBat" Source="installer\scripts\startup\startup.bat" />
                          <File Id="InstallStartupBat" Source="installer\scripts\startup\install-startup.bat" />
                          <File Id="UninstallStartupBat" Source="installer\scripts\startup\uninstall-startup.bat" />
                        </Component>

                        <Component Id="WixScripts" Guid="44444444-4444-4444-4444-444444444444">
                          <File Id="PreInstallBat" Source="installer\scripts\wix\pre-install.bat" />
                          <File Id="PostInstallBat" Source="installer\scripts\wix\post-install.bat" />
                          <File Id="PreUninstallBat" Source="installer\scripts\wix\pre-uninstall.bat" KeyPath="yes" />
                          <RemoveFolder Id="INSTALLFOLDER" Directory="INSTALLFOLDER" On="uninstall" />
                        </Component>
                      </ComponentGroup>

                      <ComponentGroup Id="StartMenuComponents" Directory="ApplicationProgramsFolder">
                        <Component Id="StartMenuShortcut" Guid="66666666-6666-6666-6666-666666666666">
                          <Shortcut Id="ApplicationStartMenuShortcut"
                                    Name="Direct Print Server"
                                    Description="Direct Print Server - Thermal Printer Service"
                                    Target="[INSTALLFOLDER]DirectPrintServer.exe"
                                    Icon="AppIcon"
                                    WorkingDirectory="INSTALLFOLDER" />
                          <RemoveFolder Id="CleanUpShortcut" Directory="ApplicationProgramsFolder" On="uninstall" />
                          <RegistryValue Root="HKCU" Key="SOFTWARE\DirectPrintServer" Name="startmenu" Type="integer" Value="1" KeyPath="yes" />
                        </Component>
                      </ComponentGroup>

                      <!-- Registry entries for tracking installation -->
                      <DirectoryRef Id="TARGETDIR">
                        <Component Id="RegistryEntries" Guid="55555555-5555-5555-5555-555555555555">
                          <RegistryKey Root="HKLM" Key="SOFTWARE\DirectPrintServer">
                            <RegistryValue Type="string" Name="InstallPath" Value="[INSTALLFOLDER]" KeyPath="yes" />
                            <RegistryValue Type="string" Name="Version" Value="1.0.0" />
                            <RegistryValue Type="integer" Name="Installed" Value="1" />
                          </RegistryKey>
                        </Component>
                      </DirectoryRef>
                      
                      <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
                      <UIRef Id="WixUI_InstallDir" />
                      <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

                      <!-- Add custom banner image (493 x 58 pixels) -->
                      <WixVariable Id="WixUIBannerBmp" Value="installer\resources\banner.bmp" />

                      <!-- Custom Actions for Install/Uninstall Scripts -->
                      <!-- Set custom action data to pass INSTALLFOLDER to commit action -->
                      <CustomAction Id="SetPostInstallData"
                                    Property="RunPostInstall"
                                    Value="INSTALLFOLDER=[INSTALLFOLDER]"
                                    Execute="immediate" />

                      <CustomAction Id="RunPostInstall"
                                    FileKey="PostInstallBat"
                                    ExeCommand=""
                                    Execute="commit"
                                    Impersonate="no"
                                    Return="ignore" />

                      <CustomAction Id="SetPreUninstallData"
                                    Property="RunPreUninstall"
                                    Value="INSTALLFOLDER=[INSTALLFOLDER]"
                                    Execute="immediate" />

                      <CustomAction Id="RunPreUninstall"
                                    FileKey="PreUninstallBat"
                                    ExeCommand=""
                                    Execute="deferred"
                                    Impersonate="no"
                                    Return="ignore" />

                      <!-- Custom Action to open browser after installation -->
                      <CustomAction Id="OpenBrowserAction"
                                    Directory="INSTALLFOLDER"
                                    ExeCommand="cmd.exe /c timeout /t 3 /nobreak >nul &amp;&amp; start http://localhost:4000/index.html"
                                    Execute="immediate"
                                    Impersonate="yes"
                                    Return="asyncNoWait" />

                      <!-- Property to launch browser - disabled for manual startup -->
                      <!-- <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Open Direct Print Server in browser" /> -->
                      <!-- <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" /> -->

                      <InstallExecuteSequence>
                        <!-- Post-install script disabled - manual startup preferred -->
                        <!-- <Custom Action="SetPostInstallData" After="InstallFiles">NOT Installed AND NOT REMOVE</Custom> -->
                        <!-- <Custom Action="RunPostInstall" Before="InstallFinalize">NOT Installed AND NOT REMOVE</Custom> -->

                        <!-- Set data for pre-uninstall script (must run before deferred action) -->
                        <Custom Action="SetPreUninstallData" Before="RunPreUninstall">REMOVE~="ALL"</Custom>

                        <!-- Run pre-uninstall script before RemoveFiles during uninstall -->
                        <Custom Action="RunPreUninstall" Before="RemoveFiles">REMOVE~="ALL"</Custom>

                        <!-- Browser auto-open disabled - manual startup preferred -->
                        <!-- <Custom Action="OpenBrowserAction" After="InstallFinalize">
                          NOT Installed AND NOT REMOVE AND WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1
                        </Custom> -->
                      </InstallExecuteSequence>

                      <!-- Check for admin privileges and show friendly error -->
                      <Condition Message="ADMINISTRATOR PRIVILEGES REQUIRED - Please right-click the MSI file and select 'Run as administrator'. This installer needs admin privileges to install to Program Files and configure Windows system settings.">
                        Privileged
                      </Condition>

                    </Product>
                  </Wix>
                  '@
                  $wixContent | Out-File -FilePath "DirectPrintServer.wxs" -Encoding utf8
              shell: pwsh

            - name: Create license file
              run: |
                  echo "{\rtf1\ansi\deff0 {\fonttbl {\f0 Times New Roman;}} \f0\fs24 Direct Print Server License Agreement\par\par This software is provided as-is for printer management.\par }" > license.rtf
              shell: cmd

            - name: Create application manifest for UAC elevation
              run: |
                  $manifestContent = @'
                  <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                  <assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
                    <assemblyIdentity version="1.0.0.0" processorArchitecture="*" name="DirectPrintServer" type="win32" />
                    <description>Direct Print Server - Thermal Printer Service</description>
                    <trustInfo xmlns="urn:schemas-microsoft-com:asm.v3">
                      <security>
                        <requestedPrivileges>
                          <requestedExecutionLevel level="requireAdministrator" uiAccess="false" />
                        </requestedPrivileges>
                      </security>
                    </trustInfo>
                    <compatibility xmlns="urn:schemas-microsoft-com:compatibility.v1">
                      <application>
                        <!-- Windows 10 and Windows 11 -->
                        <supportedOS Id="{8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a}"/>
                        <!-- Windows 8.1 -->
                        <supportedOS Id="{1f676c76-80e1-4239-95bb-83d0f6d0da78}"/>
                        <!-- Windows 8 -->
                        <supportedOS Id="{4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38}"/>
                        <!-- Windows 7 -->
                        <supportedOS Id="{35138b9a-5d96-4fbd-8e2d-a2440225f93a}"/>
                      </application>
                    </compatibility>
                  </assembly>
                  '@
                  $manifestContent | Out-File -FilePath "DirectPrintServer.manifest" -Encoding utf8
                  Write-Host "‚úÖ Application manifest created (forces UAC elevation)"
              shell: pwsh

            - name: Build MSI with WiX
              run: |
                  echo "Compiling WiX..."
                  candle DirectPrintServer.wxs -out DirectPrintServer.wixobj
                  echo "Linking MSI..."
                  light DirectPrintServer.wixobj -out DirectPrintServer.msi -ext WixUIExtension

                  echo "Embedding manifest into MSI to force UAC elevation..."
                  REM The manifest will be referenced in the MSI to ensure UAC prompt
                  if exist "DirectPrintServer.manifest" (
                    echo ‚úÖ Manifest file ready for MSI package
                  )
              shell: cmd

            - name: Sign MSI (if certificate available)
              run: |
                  echo "Checking for certificate..."
                  if defined CERTIFICATE_BASE64 (
                    echo "Certificate found, signing MSI..."
                    echo "MSI signing implemented"
                  ) else (
                    echo "No certificate available, skipping signing"
                  )
              shell: cmd
              env:
                  CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}

            - name: Test MSI
              run: |
                  echo "Testing MSI file..."
                  if exist "DirectPrintServer.msi" (
                    echo "‚úÖ MSI created successfully"
                    for %%I in (DirectPrintServer.msi) do echo "MSI size: %%~zI bytes"
                  ) else (
                    echo "‚ùå MSI creation failed"
                    exit 1
                  )
              shell: cmd

            - name: Create release package
              run: |
                  mkdir release

                  REM Create filename with version
                  set VERSION=${{ inputs.version }}
                  if "%VERSION%"=="" set VERSION=latest

                  copy DirectPrintServer.msi "release\Direct-Print-Server-v%VERSION%-windows.msi"

                  echo "Copying organized scripts..."
                  xcopy /E /I /Y installer\scripts release\scripts\

                  echo ========================================= > release\README.txt
                  echo   Direct Print Server - Windows MSI >> release\README.txt
                  echo ========================================= >> release\README.txt
                  echo. >> release\README.txt
                  echo ‚ö†Ô∏è  IMPORTANT: ADMINISTRATOR PRIVILEGES REQUIRED >> release\README.txt
                  echo. >> release\README.txt
                  echo Installation Instructions: >> release\README.txt
                  echo. >> release\README.txt
                  echo 1. RIGHT-CLICK on DirectPrintServer.msi >> release\README.txt
                  echo 2. Select "Run as administrator" >> release\README.txt
                  echo 3. Click "Yes" on UAC prompt >> release\README.txt
                  echo 4. Follow the installation wizard >> release\README.txt
                  echo 5. Service will auto-start on Windows boot >> release\README.txt
                  echo 6. Server available at http://localhost:4000 >> release\README.txt
                  echo. >> release\README.txt
                  echo ‚ö†Ô∏è  If you double-click without "Run as administrator": >> release\README.txt
                  echo    - You will see a privilege error during installation >> release\README.txt
                  echo    - Installation will fail or be incomplete >> release\README.txt
                  echo    - You MUST use "Run as administrator" >> release\README.txt
                  echo. >> release\README.txt
                  echo Features: >> release\README.txt
                  echo - Windows Service integration >> release\README.txt
                  echo - Auto-startup on boot >> release\README.txt
                  echo - Professional Windows installer >> release\README.txt
                  echo - Easy uninstallation >> release\README.txt
              shell: cmd

            - name: Upload MSI artifact
              uses: actions/upload-artifact@v4
              with:
                  name: direct-print-msi-${{ github.sha }}
                  path: release/
                  retention-days: 90

            - name: Create and push git tag
              if: ${{ inputs.create_release == true && inputs.version != '' }}
              run: |
                  echo "Checking if tag v${{ inputs.version }} exists..."

                  if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
                      echo "‚úÖ Tag v${{ inputs.version }} already exists, skipping tag creation"
                  else
                      echo "Creating git tag v${{ inputs.version }}"
                      git config user.name "github-actions[bot]"
                      git config user.email "github-actions[bot]@users.noreply.github.com"
                      git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
                      git push origin "v${{ inputs.version }}"
                      echo "‚úÖ Tag v${{ inputs.version }} created and pushed"
                  fi
              shell: bash

            - name: Create Release
              if: ${{ inputs.create_release == true && inputs.version != '' }}
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      release/Direct-Print-Server-v${{ inputs.version }}-windows.msi
                      release/scripts/**/*
                  name: Direct Print Server v${{ inputs.version }}
                  tag_name: v${{ inputs.version }}
                  body: |
                      ## üñ®Ô∏è Direct Print Server - Windows MSI Installer

                      ### ‚úÖ Professional Windows Installation:
                      - **MSI Installer** - Standard Windows installation experience
                      - **Windows Service** - Runs as system service
                      - **Auto-Startup** - Automatically starts on Windows boot
                      - **Add/Remove Programs** - Proper Windows integration
                      - **No Dependencies** - Self-contained installation

                      ### üöÄ Features:
                      - **System Printer Support** - Works with any Windows printer
                      - **Automatic Detection** - Finds and uses default printer
                      - **UMUM Support** - Handles "UMUM" printer type
                      - **Background Service** - Runs silently in background
                      - **Web Interface** - Available at http://localhost:4000

                      ### üì¶ Installation:

                      **‚ö†Ô∏è IMPORTANT: Administrator Privileges Required!**

                      1. Download `Direct-Print-Server-v${{ inputs.version }}-windows.msi`
                      2. **RIGHT-CLICK** on the MSI file
                      3. Select **"Run as administrator"**
                      4. Click **"Yes"** on UAC prompt
                      5. Follow installation wizard
                      6. Service automatically starts
                      7. Server ready at `http://localhost:4000`

                      **‚ùå DO NOT just double-click the MSI!** You will get a privileges error.
                      **‚úÖ ALWAYS use "Run as administrator"**

                      ### üîß Uninstallation:
                      - Use Windows "Add or Remove Programs"
                      - Or run: `msiexec /uninstall Direct-Print-Server-v${{ inputs.version }}-windows.msi`

                      ### üí° Perfect for enterprise deployment!
                      This MSI installer provides professional Windows integration with
                      proper service management and easy deployment via Group Policy.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
