name: Build macOS DMG Package

on:
    workflow_dispatch:
        inputs:
            create_release:
                description: "Create GitHub Release"
                required: false
                default: false
                type: boolean
            version:
                description: "Version number (e.g., 1.0.0) - required if creating release"
                required: false
                default: ""
                type: string

jobs:
    build-dmg:
        runs-on: macos-latest
        name: Build macOS DMG Package
        permissions:
            contents: write  # Required for creating tags and releases

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch all history for tagging
                  persist-credentials: true

            - name: Setup Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              run: |
                  echo "Installing Node.js dependencies..."
                  npm install

            - name: Install pkg globally
              run: |
                  echo "Installing @yao-pkg/pkg for Node 20 support..."
                  npm install -g @yao-pkg/pkg

            - name: Build macOS executable
              run: |
                  echo "Building macOS x64 executable..."
                  pkg . --targets node20-macos-x64 --output ./dist/direct-print-macos
                  chmod +x ./dist/direct-print-macos

                  echo "Verifying executable..."
                  ls -lh ./dist/direct-print-macos
                  file ./dist/direct-print-macos

            - name: Install DMG creation tools
              run: |
                  echo "Installing create-dmg..."
                  brew install create-dmg

            - name: Create .app bundle structure
              run: |
                  echo "Creating macOS .app bundle..."

                  # Create app structure
                  mkdir -p "DirectPrintServer.app/Contents/MacOS"
                  mkdir -p "DirectPrintServer.app/Contents/Resources"

                  echo "‚úÖ App bundle structure created"

            - name: Copy executable to app bundle
              run: |
                  echo "Copying executable..."

                  # Copy the actual server binary
                  cp dist/direct-print-macos "DirectPrintServer.app/Contents/MacOS/direct-print-server-bin"
                  chmod +x "DirectPrintServer.app/Contents/MacOS/direct-print-server-bin"

                  # Create wrapper script that handles LaunchAgent installation
                  cat > "DirectPrintServer.app/Contents/MacOS/DirectPrintServer" << 'WRAPPER_EOF'
#!/bin/bash

# DirectPrintServer Auto-Install Wrapper
# This script automatically sets up LaunchAgent on first run

APP_PATH="/Applications/DirectPrintServer.app"
LAUNCH_AGENT_DIR="$HOME/Library/LaunchAgents"
LAUNCH_AGENT_PLIST="$LAUNCH_AGENT_DIR/com.aiqbalsyah.directprintserver.plist"
LABEL="com.aiqbalsyah.directprintserver"

# Check if we're running from /Applications
CURRENT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

# Function to install LaunchAgent
install_launch_agent() {
    mkdir -p "$LAUNCH_AGENT_DIR"

    cat > "$LAUNCH_AGENT_PLIST" << 'PLIST_EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.aiqbalsyah.directprintserver</string>
    <key>ProgramArguments</key>
    <array>
        <string>/Applications/DirectPrintServer.app/Contents/MacOS/direct-print-server-bin</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/tmp/direct-print-server.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/direct-print-server-error.log</string>
</dict>
</plist>
PLIST_EOF

    # Load the LaunchAgent
    launchctl unload "$LAUNCH_AGENT_PLIST" 2>/dev/null || true
    launchctl load "$LAUNCH_AGENT_PLIST"
    launchctl start "$LABEL"
}

# If app is in /Applications and LaunchAgent not installed, install it
if [[ "$CURRENT_PATH" == "$APP_PATH" ]]; then
    if [[ ! -f "$LAUNCH_AGENT_PLIST" ]]; then
        echo "First run detected. Installing LaunchAgent for auto-startup..."
        install_launch_agent

        # Open browser after installation
        sleep 2
        open "http://localhost:4000/index.html" 2>/dev/null || true

        # Show notification
        osascript -e 'display notification "Direct Print Server is now running at http://localhost:4000" with title "Direct Print Server Started"' 2>/dev/null || true

        echo "‚úÖ Direct Print Server installed and started!"
        echo "   Access at: http://localhost:4000"
        exit 0
    else
        # LaunchAgent already exists, just ensure it's running
        if ! launchctl list | grep -q "$LABEL"; then
            launchctl start "$LABEL" 2>/dev/null || true
        fi

        # Open browser
        open "http://localhost:4000/index.html" 2>/dev/null || true
        exit 0
    fi
else
    # Running from DMG or other location - just start the server directly
    echo "Running from: $CURRENT_PATH"
    echo "For auto-startup, please move to /Applications first"
    exec "$CURRENT_PATH/Contents/MacOS/direct-print-server-bin"
fi
WRAPPER_EOF

                  chmod +x "DirectPrintServer.app/Contents/MacOS/DirectPrintServer"

                  # Copy public assets
                  if [ -d "public" ]; then
                    cp -r public "DirectPrintServer.app/Contents/Resources/"
                  fi

                  echo "‚úÖ Executable and wrapper created"

            - name: Create Info.plist
              run: |
                  cat > "DirectPrintServer.app/Contents/Info.plist" << 'EOF'
                  <?xml version="1.0" encoding="UTF-8"?>
                  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                  <plist version="1.0">
                  <dict>
                      <key>CFBundleDevelopmentRegion</key>
                      <string>en</string>
                      <key>CFBundleExecutable</key>
                      <string>DirectPrintServer</string>
                      <key>CFBundleIdentifier</key>
                      <string>com.aiqbalsyah.directprintserver</string>
                      <key>CFBundleInfoDictionaryVersion</key>
                      <string>6.0</string>
                      <key>CFBundleName</key>
                      <string>Direct Print Server</string>
                      <key>CFBundlePackageType</key>
                      <string>APPL</string>
                      <key>CFBundleShortVersionString</key>
                      <string>1.0.0</string>
                      <key>CFBundleVersion</key>
                      <string>1</string>
                      <key>LSMinimumSystemVersion</key>
                      <string>10.13</string>
                      <key>LSUIElement</key>
                      <true/>
                      <key>NSHighResolutionCapable</key>
                      <true/>
                      <key>NSPrincipalClass</key>
                      <string>NSApplication</string>
                      <key>CFBundleDisplayName</key>
                      <string>Direct Print Server</string>
                      <key>NSHumanReadableCopyright</key>
                      <string>Copyright ¬© 2024. All rights reserved.</string>
                  </dict>
                  </plist>
                  EOF

                  echo "‚úÖ Info.plist created"




            - name: Create README
              run: |
                  cat > "README.txt" << 'EOF'
                  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                  ‚ïë   Direct Print Server for macOS - v1.0.0    ‚ïë
                  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

                  üì¶ SUPER EASY INSTALLATION
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  1. Drag "DirectPrintServer.app" to Applications folder
                  2. Double-click to open
                  3. Done! ‚úÖ

                  The app will automatically:
                  ‚Ä¢ Install LaunchAgent for auto-startup
                  ‚Ä¢ Start the print server
                  ‚Ä¢ Open browser to http://localhost:4000
                  ‚Ä¢ Show a notification when ready

                  üîê FIRST RUN - SECURITY NOTICE
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  If you see "DirectPrintServer is damaged":

                  Option 1 (Terminal):
                    xattr -cr /Applications/DirectPrintServer.app
                    open /Applications/DirectPrintServer.app

                  Option 2 (System Preferences):
                    System Preferences ‚Üí Security & Privacy ‚Üí Click "Open Anyway"

                  This is normal for unsigned apps. The app is NOT damaged.

                  ‚úÖ VERIFY INSTALLATION
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  ‚Ä¢ Check service: launchctl list | grep directprintserver
                  ‚Ä¢ Open browser: http://localhost:4000
                  ‚Ä¢ View logs: tail -f /tmp/direct-print-server.log

                  üóëÔ∏è  UNINSTALLATION
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  1. Stop service:
                     launchctl stop com.aiqbalsyah.directprintserver
                     launchctl unload ~/Library/LaunchAgents/com.aiqbalsyah.directprintserver.plist

                  2. Delete files:
                     rm ~/Library/LaunchAgents/com.aiqbalsyah.directprintserver.plist
                     rm -rf /Applications/DirectPrintServer.app
                     rm /tmp/direct-print-server*.log

                  üìã REQUIREMENTS
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  ‚Ä¢ macOS 10.13 (High Sierra) or later
                  ‚Ä¢ CUPS (pre-installed on macOS)
                  ‚Ä¢ Printer configured in System Preferences

                  üîß TROUBLESHOOTING
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  Service won't start?
                  ‚Üí Check logs: cat /tmp/direct-print-server-error.log
                  ‚Üí Check port: lsof -i:4000
                  ‚Üí Check printers: lpstat -p -d

                  Browser doesn't open?
                  ‚Üí Manually visit: http://localhost:4000

                  üí¨ SUPPORT
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  GitHub: https://github.com/aiqbalsyah/direct-print-utils-pos
                  Issues: https://github.com/aiqbalsyah/direct-print-utils-pos/issues
                  EOF

                  echo "‚úÖ README created"

            - name: Create DMG package
              run: |
                  echo "Creating DMG package..."

                  # Remove quarantine attributes from app (prevents Gatekeeper "damaged" error)
                  echo "Removing quarantine attributes..."
                  xattr -cr DirectPrintServer.app || true

                  # Create temporary directory for DMG contents
                  mkdir -p dmg-contents
                  cp -R DirectPrintServer.app dmg-contents/
                  cp README.txt dmg-contents/

                  # Remove quarantine from all DMG contents
                  xattr -cr dmg-contents/* || true

                  # Create symlink to Applications folder for drag-and-drop
                  ln -s /Applications dmg-contents/Applications

                  # Create DMG with drag-and-drop layout
                  create-dmg \
                    --volname "Direct Print Server" \
                    --volicon "DirectPrintServer.app/Contents/Resources/AppIcon.icns" \
                    --window-pos 200 120 \
                    --window-size 660 400 \
                    --icon-size 128 \
                    --icon "DirectPrintServer.app" 180 170 \
                    --icon "README.txt" 180 300 \
                    --hide-extension "DirectPrintServer.app" \
                    --app-drop-link 480 170 \
                    --no-internet-enable \
                    "DirectPrintServer-1.0.0.dmg" \
                    "dmg-contents/" || true

                  # Fallback: Create simple DMG if create-dmg fails
                  if [ ! -f "DirectPrintServer-1.0.0.dmg" ]; then
                    echo "Using fallback DMG creation method..."
                    hdiutil create -volname "Direct Print Server" -srcfolder dmg-contents -ov -format UDZO DirectPrintServer-1.0.0.dmg
                  fi

                  echo "Verifying DMG..."
                  ls -lh DirectPrintServer-1.0.0.dmg

                  echo "‚úÖ DMG package created successfully!"

            - name: Test DMG package
              run: |
                  echo "Testing DMG package..."

                  # Mount DMG
                  hdiutil attach DirectPrintServer-1.0.0.dmg -mountpoint /tmp/test-dmg

                  # Verify contents
                  ls -la /tmp/test-dmg/

                  # Unmount
                  hdiutil detach /tmp/test-dmg

                  echo "‚úÖ DMG test completed"

            - name: Create release package
              run: |
                  mkdir -p release

                  # Create filename with version
                  VERSION="${{ inputs.version }}"
                  if [ -z "$VERSION" ]; then
                      VERSION="latest"
                  fi

                  cp DirectPrintServer-1.0.0.dmg "release/Direct-Print-Server-v${VERSION}-macos.dmg"

                  # Create installation guide
                  cat > release/INSTALL.txt << 'EOF'
                  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                  ‚ïë  Direct Print Server - macOS Drag-and-Drop Install  ‚ïë
                  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

                  üì¶ INSTALLATION (3 STEPS)
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  1. Open the DMG file
                  2. Drag "DirectPrintServer.app" to Applications folder
                  3. Double-click DirectPrintServer.app

                  ‚ú® That's it! The app will:
                  ‚Ä¢ Auto-install LaunchAgent for startup
                  ‚Ä¢ Start the server
                  ‚Ä¢ Open browser to http://localhost:4000
                  ‚Ä¢ Show macOS notification when ready

                  üîê GATEKEEPER WARNING?
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  If you see "DirectPrintServer is damaged":

                  Terminal fix:
                    xattr -cr /Applications/DirectPrintServer.app
                    open /Applications/DirectPrintServer.app

                  OR

                  System Preferences:
                    Security & Privacy ‚Üí "Open Anyway"

                  This is normal for unsigned apps.

                  ‚úÖ VERIFY
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  launchctl list | grep directprintserver
                  open http://localhost:4000

                  üóëÔ∏è  UNINSTALL
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  launchctl stop com.aiqbalsyah.directprintserver
                  launchctl unload ~/Library/LaunchAgents/com.aiqbalsyah.directprintserver.plist
                  rm ~/Library/LaunchAgents/com.aiqbalsyah.directprintserver.plist
                  rm -rf /Applications/DirectPrintServer.app

                  üìã REQUIREMENTS
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  ‚Ä¢ macOS 10.13+ (High Sierra or later)
                  ‚Ä¢ CUPS (pre-installed on macOS)
                  ‚Ä¢ Printer in System Preferences

                  üí¨ SUPPORT
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  GitHub: https://github.com/aiqbalsyah/direct-print-utils-pos
                  EOF

                  echo "‚úÖ Release package created"

            - name: Upload DMG artifact
              uses: actions/upload-artifact@v4
              with:
                  name: direct-print-macos-dmg-${{ github.sha }}
                  path: release/
                  retention-days: 90

            - name: Create and push git tag
              if: ${{ inputs.create_release == true && inputs.version != '' }}
              run: |
                  echo "Checking if tag v${{ inputs.version }} exists..."

                  if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
                      echo "‚úÖ Tag v${{ inputs.version }} already exists, skipping tag creation"
                  else
                      echo "Creating git tag v${{ inputs.version }}"
                      git config user.name "github-actions[bot]"
                      git config user.email "github-actions[bot]@users.noreply.github.com"
                      git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
                      git push origin "v${{ inputs.version }}"
                      echo "‚úÖ Tag v${{ inputs.version }} created and pushed"
                  fi

            - name: Create Release
              if: ${{ inputs.create_release == true && inputs.version != '' }}
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      release/Direct-Print-Server-v${{ inputs.version }}-macos.dmg
                      release/INSTALL.txt
                  name: Direct Print Server v${{ inputs.version }}
                  tag_name: v${{ inputs.version }}
                  body: |
                      ## üçé Direct Print Server - macOS DMG Package

                      ### üì¶ Professional macOS Application Bundle

                      **Features:**
                      - ‚úÖ **Native .app Bundle** - Standard macOS application
                      - ‚úÖ **DMG Installer** - Easy drag-and-drop installation
                      - ‚úÖ **LaunchAgent Integration** - Auto-start on login
                      - ‚úÖ **CUPS Support** - Works with any macOS printer
                      - ‚úÖ **Background Service** - Runs silently in background

                      ### üöÄ Super Easy Installation (Drag-and-Drop!)

                      **Just 3 Steps:**
                      1. Open `Direct-Print-Server-v${{ inputs.version }}-macos.dmg`
                      2. Drag `DirectPrintServer.app` to Applications folder
                      3. Double-click to open

                      **The app automatically:**
                      - Installs LaunchAgent for auto-startup
                      - Starts the print server
                      - Opens browser to http://localhost:4000
                      - Shows notification when ready

                      **No install.sh needed! No sudo required!**

                      ### üíª Supported macOS Versions

                      - macOS 15 Sequoia
                      - macOS 14 Sonoma
                      - macOS 13 Ventura
                      - macOS 12 Monterey
                      - macOS 11 Big Sur
                      - macOS 10.15 Catalina
                      - macOS 10.14 Mojave
                      - macOS 10.13 High Sierra

                      ### üéØ Package Contents

                      - `DirectPrintServer.app` - Self-installing application bundle
                      - `README.txt` - Installation and usage instructions
                      - Drag-and-drop installer (Applications folder shortcut)

                      ### üîß Management Commands

                      ```bash
                      # Check service status
                      launchctl list | grep directprintserver

                      # View logs
                      tail -f /tmp/direct-print-server.log

                      # Restart service
                      launchctl stop com.aiqbalsyah.directprintserver
                      launchctl start com.aiqbalsyah.directprintserver

                      # Uninstall
                      launchctl stop com.aiqbalsyah.directprintserver
                      launchctl unload ~/Library/LaunchAgents/com.aiqbalsyah.directprintserver.plist
                      rm ~/Library/LaunchAgents/com.aiqbalsyah.directprintserver.plist
                      rm -rf /Applications/DirectPrintServer.app
                      ```

                      ### üìã Requirements

                      - macOS 10.13 or later
                      - CUPS printing system (pre-installed)
                      - Printer configured in System Preferences
                      - **No sudo required!** Runs as user-level app

                      ### üîê Security Notes

                      - Service runs as user-level LaunchAgent (no root access)
                      - **No administrator privileges needed**
                      - All data stays local (no internet required)
                      - Open source - verify code before installing
                      - Self-installing on first run

                      ### ‚ö†Ô∏è Gatekeeper "Damaged App" Warning?

                      If you see "DirectPrintServer is damaged and can't be opened":

                      **Quick Fix:**
                      ```bash
                      xattr -cr /Applications/DirectPrintServer.app
                      open /Applications/DirectPrintServer.app
                      ```

                      **Or:** System Preferences ‚Üí Security & Privacy ‚Üí Click "Open Anyway"

                      This is normal for unsigned apps. The app is NOT damaged - it's a macOS security feature.

                      Perfect for macOS servers and desktop deployments!
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
