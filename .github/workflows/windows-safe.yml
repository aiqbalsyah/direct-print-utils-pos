name: Windows USB-Safe Build

on:
    push:
        paths:
            - "src/**"
            - "package*.json"
    workflow_dispatch:
        inputs:
            create_release:
                description: "Create GitHub Release"
                required: false
                default: false
                type: boolean

jobs:
    build-windows-safe:
        runs-on: windows-latest
        name: Build USB-Safe Windows Version

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js 18
              uses: actions/setup-node@v4
              with:
                  node-version: "18.18.0"
                  registry-url: "https://registry.npmjs.org"

            - name: Create Windows-safe package.json
              run: |
                  echo "Creating Windows-safe configuration..."
                  $packageContent = @"
                  {
                    "name": "direct_print_js_windows_safe",
                    "version": "1.0.0",
                    "main": "./src/index.js",
                    "engines": { "node": "18.18.0" },
                    "description": "Windows-safe direct print server",
                    "dependencies": {
                      "express": "^4.18.2",
                      "socket.io": "^4.7.2"
                    },
                    "devDependencies": {
                      "pkg": "^5.8.1"
                    },
                    "pkg": {
                      "scripts": "./src/index.js",
                      "outputPath": "./dist",
                      "assets": ["public/**/*", "src/**/*"],
                      "targets": ["node18-win-x64"]
                    }
                  }
                  "@
                  $packageContent | Out-File -FilePath "package-safe.json" -Encoding utf8
              shell: pwsh

            - name: Backup and use safe package.json
              run: |
                  copy package.json package-original.json
                  copy package-safe.json package.json
              shell: cmd

            - name: Install safe dependencies
              run: |
                  npm install
                  npm install -g pkg
              shell: cmd

            - name: Build Windows-safe executable
              run: |
                  echo "Building USB-safe Windows executable..."
                  pkg . --targets node18-win-x64 --output ./dist/direct-print-windows-safe.exe
              shell: cmd

            - name: Restore original package.json
              run: |
                  copy package-original.json package.json
                  del package-original.json
                  del package-safe.json
              shell: cmd

            - name: Copy startup scripts
              run: |
                  copy scripts\*.bat dist\
              shell: cmd

            - name: Create deployment package
              run: |
                  mkdir release
                  copy dist\direct-print-windows-safe.exe release\direct-print-win.exe
                  copy dist\*.bat release\
                  echo Windows-Safe Direct Print Server > release\README.txt
                  echo. >> release\README.txt
                  echo This version is optimized for Windows: >> release\README.txt
                  echo - No USB dependency issues >> release\README.txt
                  echo - Uses Windows system printers only >> release\README.txt
                  echo - Compatible with all Windows printer types >> release\README.txt
                  echo - Automatic printer detection >> release\README.txt
                  echo - UMUM printer type support >> release\README.txt
                  echo. >> release\README.txt
                  echo Installation: >> release\README.txt
                  echo 1. Run install-startup.bat as Administrator >> release\README.txt
                  echo 2. Or run direct-print-win.exe manually >> release\README.txt
                  echo 3. Server available at http://localhost:4000 >> release\README.txt
              shell: cmd

            - name: Test executable
              run: |
                  echo "Testing Windows-safe build..."
                  if exist "release\direct-print-win.exe" (
                    echo ‚úÖ Windows-safe build successful
                    for %%I in (release\direct-print-win.exe) do echo File size: %%~zI bytes
                  ) else (
                    echo ‚ùå Build failed
                    exit 1
                  )
              shell: cmd

            - name: Upload Windows-safe build
              uses: actions/upload-artifact@v4
              with:
                  name: direct-print-windows-safe-${{ github.sha }}
                  path: release/
                  retention-days: 90

            - name: Create Release
              if: ${{ inputs.create_release }}
              uses: softprops/action-gh-release@v1
              with:
                  files: release/*
                  name: Direct Print Windows Safe v${{ github.run_number }}
                  tag_name: windows-safe-v${{ github.run_number }}
                  body: |
                      ## üñ®Ô∏è Direct Print - Windows Safe Edition

                      ### ‚úÖ Windows Optimized Features:
                      - **No USB Library Issues** - Eliminates "usb.on is not a function" errors
                      - **System Printer Only** - Works with any Windows-installed printer
                      - **Automatic Detection** - Finds and uses default Windows printer
                      - **UMUM Support** - Handles "UMUM" printer type as auto-detect
                      - **Auto-Startup** - Runs automatically on Windows boot
                      - **Standalone** - No Node.js or dependencies required

                      ### üöÄ Installation:
                      1. Download `direct-print-win.exe`
                      2. Download `install-startup.bat`
                      3. Run `install-startup.bat` as Administrator
                      4. Restart Windows
                      5. Server automatically available at `http://localhost:4000`

                      ### üí° Perfect for Windows deployment!
                      This version completely avoids USB native modules that cause issues on Windows,
                      instead using reliable Windows system printing commands.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
