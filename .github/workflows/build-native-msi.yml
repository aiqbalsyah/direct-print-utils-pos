name: Build Windows MSI (Native)

on:
    workflow_dispatch:
        inputs:
            create_release:
                description: "Create GitHub Release"
                required: false
                default: false
                type: boolean

jobs:
    build-native-msi:
        runs-on: windows-latest
        name: Build MSI with Windows Tools

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18.18.0"

            - name: Create Windows-safe package.json
              run: |
                  $packageContent = @"
                  {
                    "name": "direct_print_server",
                    "version": "1.0.0",
                    "main": "./src/index.js",
                    "dependencies": {
                      "express": "^4.18.2",
                      "socket.io": "^4.7.2"
                    },
                    "devDependencies": {
                      "pkg": "^5.8.1"
                    }
                  }
                  "@
                  $packageContent | Out-File -FilePath "package-safe.json" -Encoding utf8
              shell: pwsh

            - name: Build executable
              run: |
                  copy package-safe.json package.json
                  npm install
                  npm install -g pkg
                  pkg . --targets node18-win-x64 --output ./build/DirectPrintServer.exe
              shell: cmd

            - name: Create installer structure
              run: |
                  mkdir msi-build
                  mkdir msi-build\DirectPrintServer
                  copy build\DirectPrintServer.exe msi-build\DirectPrintServer\
                  copy scripts\*.bat msi-build\DirectPrintServer\

                  echo @echo off > msi-build\DirectPrintServer\install.bat
                  echo echo Installing Direct Print Server as Windows Service... >> msi-build\DirectPrintServer\install.bat
                  echo sc create "DirectPrintService" binPath= "%%~dp0DirectPrintServer.exe" start= auto DisplayName= "Direct Print Server" >> msi-build\DirectPrintServer\install.bat
                  echo sc description "DirectPrintService" "Automatic printing service" >> msi-build\DirectPrintServer\install.bat
                  echo sc start "DirectPrintService" >> msi-build\DirectPrintServer\install.bat
                  echo echo Service installed and started! >> msi-build\DirectPrintServer\install.bat
                  echo echo Server available at http://localhost:4000 >> msi-build\DirectPrintServer\install.bat

                  echo @echo off > msi-build\DirectPrintServer\uninstall.bat
                  echo echo Removing Direct Print Server... >> msi-build\DirectPrintServer\uninstall.bat
                  echo sc stop "DirectPrintService" >> msi-build\DirectPrintServer\uninstall.bat
                  echo sc delete "DirectPrintService" >> msi-build\DirectPrintServer\uninstall.bat
                  echo echo Service removed! >> msi-build\DirectPrintServer\uninstall.bat
              shell: cmd

            - name: Install Advanced Installer
              run: |
                  echo "Installing Advanced Installer..."
                  choco install advanced-installer -y --ignore-checksums
                  echo "C:\Program Files (x86)\Caphyon\Advanced Installer 21.9\bin\x86" >> $GITHUB_PATH
              shell: pwsh

            - name: Create Advanced Installer Project
              run: |
                  echo "Creating Advanced Installer project..."
                  $aiProjectContent = @'
                  <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                  <DOCUMENT Type="Advanced Installer" CreateVersion="21.9" version="21.9" Modules="professional" RootPath="." Language="en" Id="{12345678-1234-1234-1234-123456789012}">
                    <COMPONENT cid="caphyon.advinst.msicomp.ProjectOptionsComponent">
                      <ROW Name="HiddenItems" Value="AppXProductDetailsComponent;AppXDependenciesComponent;AppXAppDeclarationsComponent;AppXCapabilitiesComponent;AppXAppExtensionsComponent;AppXPackagingComponent;AppXUWPComponent;AppXWin10PackagingComponent;AppXWin11PackagingComponent"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.MsiPropsComponent">
                      <ROW Property="ProductCode" Value="1033:{12345678-1234-1234-1234-123456789012} " Type="16"/>
                      <ROW Property="ProductLanguage" Value="1033" Type="4"/>
                      <ROW Property="ProductName" Value="Direct Print Server" ValueLocId="*"/>
                      <ROW Property="ProductVersion" Value="1.0.0" Type="32"/>
                      <ROW Property="UpgradeCode" Value="{87654321-4321-4321-4321-210987654321}"/>
                      <ROW Property="ARPPRODUCTICON" Value="DirectPrintServer.exe" Type="8"/>
                      <ROW Property="Manufacturer" Value="Direct Print Solutions" ValueLocId="*"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.MsiDirsComponent">
                      <ROW Directory="APPDIR" Directory_Parent="TARGETDIR" DefaultDir="APPDIR:.:DirectPrintServer"/>
                      <ROW Directory="TARGETDIR" DefaultDir="SourceDir"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.MsiCompsComponent">
                      <ROW Component="DirectPrintServer.exe" ComponentId="{11111111-1111-1111-1111-111111111111}" Directory="APPDIR" Attributes="0" KeyPath="DirectPrintServer.exe"/>
                      <ROW Component="Scripts" ComponentId="{22222222-2222-2222-2222-222222222222}" Directory="APPDIR" Attributes="0" KeyPath="install.bat"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.MsiFilesComponent">
                      <ROW File="DirectPrintServer.exe" Component="DirectPrintServer.exe" FileName="DirectPrintServer.exe" Attributes="0" SourcePath="msi-build\DirectPrintServer\DirectPrintServer.exe"/>
                      <ROW File="install.bat" Component="Scripts" FileName="install.bat" Attributes="0" SourcePath="msi-build\DirectPrintServer\install.bat"/>
                      <ROW File="uninstall.bat" Component="Scripts" FileName="uninstall.bat" Attributes="0" SourcePath="msi-build\DirectPrintServer\uninstall.bat"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.MsiFeaturesComponent">
                      <ROW Feature="MainFeature" Title="Direct Print Server" Description="Main application files" Display="1" Level="1" Directory="APPDIR" Attributes="0"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.MsiFeatureCompsComponent">
                      <ROW Feature="MainFeature" Component="DirectPrintServer.exe"/>
                      <ROW Feature="MainFeature" Component="Scripts"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.MsiInstExSeqComponent">
                      <ROW Action="AI_DOWNGRADE" Condition="AI_NEWERPRODUCTFOUND AND (UILevel &lt;&gt; 5)" Sequence="210"/>
                      <ROW Action="AI_RESTORE_LOCATION" Condition="APPDIR=&quot;&quot;" Sequence="749"/>
                      <ROW Action="AI_STORE_LOCATION" Condition="(Not Installed) OR REINSTALL" Sequence="1501"/>
                      <ROW Action="AI_PREPARE_UPGRADE" Condition="AI_UPGRADE=&quot;No&quot; AND (Not Installed)" Sequence="1399"/>
                    </COMPONENT>
                    <COMPONENT cid="caphyon.advinst.msicomp.BuildComponent">
                      <ROW BuildKey="DefaultBuild" BuildName="DefaultBuild" BuildOrder="1" BuildType="0" PackageFolder="..\dist-msi" PackageFileName="DirectPrintServer" Languages="en" InstallationType="4" UseLargeSchema="true"/>
                    </COMPONENT>
                  </DOCUMENT>
                  '@
                  $aiProjectContent | Out-File -FilePath "DirectPrintServer.aip" -Encoding utf8
              shell: pwsh

            - name: Build MSI with Advanced Installer
              run: |
                  mkdir dist-msi
                  AdvancedInstaller.com /build DirectPrintServer.aip
              shell: cmd
              continue-on-error: true

            - name: Fallback - Create simple MSI with PowerShell
              if: failure()
              run: |
                  echo "Advanced Installer failed, creating simple MSI with PowerShell..."

                  # Create a simple MSI using WScript and Windows Installer
                  $createMsiScript = @'
                  param($SourceDir, $OutputFile)

                  Write-Host "Creating MSI package..."

                  # This creates a very basic MSI - for production use WiX or Advanced Installer
                  $installer = New-Object -ComObject WindowsInstaller.Installer
                  $database = $installer.GetType().InvokeMember("OpenDatabase", "InvokeMethod", $null, $installer, @($OutputFile, 1))

                  Write-Host "MSI package created: $OutputFile"
                  '@

                  $createMsiScript | Out-File -FilePath "create-msi.ps1" -Encoding utf8

                  # For now, create a ZIP file as fallback
                  Compress-Archive -Path "msi-build\DirectPrintServer\*" -DestinationPath "dist-msi\DirectPrintServer-Portable.zip"
                  echo "Created portable ZIP package as fallback"
              shell: pwsh

            - name: Verify build output
              run: |
                  echo "Build output:"
                  dir dist-msi
                  if exist "dist-msi\*.msi" (
                    echo "‚úÖ MSI created successfully"
                  ) else if exist "dist-msi\*.zip" (
                    echo "‚úÖ Portable ZIP created as fallback"
                  ) else (
                    echo "‚ùå No output created"
                  )
              shell: cmd

            - name: Upload MSI/ZIP
              uses: actions/upload-artifact@v4
              with:
                  name: direct-print-native-msi-${{ github.sha }}
                  path: |
                      dist-msi/*
                      msi-build/DirectPrintServer/*
                  retention-days: 90

            - name: Create Release
              if: ${{ inputs.create_release }}
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      dist-msi/*
                      msi-build/DirectPrintServer/*
                  name: Direct Print Server Native v${{ github.run_number }}
                  tag_name: native-v${{ github.run_number }}
                  body: |
                      ## üñ®Ô∏è Direct Print Server - Native Windows Package

                      ### üì¶ Installation Options:
                      - **MSI Installer** (if available) - Standard Windows installation
                      - **Portable ZIP** - Extract and run anywhere
                      - **Service Scripts** - Manual service installation

                      ### ‚úÖ Features:
                      - **Windows Service** - Runs as system service
                      - **Auto-Start** - Starts with Windows
                      - **System Printers** - Works with any Windows printer
                      - **No Dependencies** - Self-contained package

                      ### üöÄ Installation:

                      **Option 1 - MSI Installer:**
                      1. Download and run `DirectPrintServer.msi`
                      2. Follow installation wizard

                      **Option 2 - Portable:**
                      1. Download `DirectPrintServer-Portable.zip`
                      2. Extract to desired location
                      3. Run `install.bat` as Administrator
                      4. Server starts automatically

                      **Option 3 - Manual:**
                      1. Download `DirectPrintServer.exe`
                      2. Run directly or use provided batch scripts

                      ### üîß Service Management:
                      - Install: Run `install.bat` as Administrator
                      - Uninstall: Run `uninstall.bat` as Administrator
                      - Manual: Use Windows Services manager

                      Server available at: `http://localhost:4000`
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
