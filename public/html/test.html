<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Print Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Direct Print Test</h1>
        
        <div style="margin: 20px 0;">
            <label for="printerName">Select Printer:</label>
            <select id="printerName" style="margin: 10px; padding: 5px; width: 200px;">
                <option value="auto">Auto Detect</option>
            </select>
            <button onclick="loadPrinters()" style="margin-left: 10px; padding: 5px 10px;">Refresh Printers</button>
        </div>
        
        <div style="margin: 20px 0;">
            <label for="transactionId">Transaction ID:</label>
            <input type="text" id="transactionId" value="TRX001" style="margin: 10px; padding: 5px;">
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="printStruk()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
                Print Receipt
            </button>
            <button onclick="checkPrinterStatus()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; margin-left: 10px;">
                Check Printer Status
            </button>
        </div>
        
        <div id="status" style="margin: 20px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            Status: Ready
        </div>
        
        <div id="log" style="margin: 20px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; height: 200px; overflow-y: auto;">
            <h3>Log:</h3>
        </div>
    </div>

    <script>
        const hostUrl = 'http://localhost:4000/';
        const socket2 = io('http://localhost:4000');
        
        // Log function
        function log(message) {
            const logDiv = document.getElementById('log');
            const now = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${now}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Socket connection events
        socket2.on('connect', () => {
            log('‚úÖ Connected to print server');
            loadPrinters();
        });
        
        socket2.on('disconnect', () => {
            log('‚ùå Disconnected from print server');
        });
        
        // Track current print job
        let currentPrintJob = null;

        socket2.on('print-job-created', (data) => {
            currentPrintJob = data.jobId;
            log(`üìù Print job created: ${data.jobId}`);
        });

        socket2.on('print-status', (status) => {
            const statusEmoji = {
                'pending': '‚è≥',
                'preparing': 'üîÑ',
                'sending': 'üì§',
                'printing': 'üñ®Ô∏è',
                'success': '‚úÖ',
                'error': '‚ùå'
            }[status.status] || 'üìã';

            log(`${statusEmoji} ${status.status.toUpperCase()}: ${status.message} (${status.progress}%)`);

            // Update SweetAlert with status
            if (status.status === 'preparing' || status.status === 'sending' || status.status === 'printing') {
                Swal.update({
                    html: `<div style="text-align: left;">
                        <p><strong>Status:</strong> ${status.message}</p>
                        <div style="background: #f0f0f0; border-radius: 10px; height: 20px; margin: 10px 0;">
                            <div style="background: #007bff; height: 100%; border-radius: 10px; width: ${status.progress}%; transition: width 0.3s;"></div>
                        </div>
                        <p style="text-align: center; color: #666;">${status.progress}%</p>
                    </div>`
                });
            }
        });

        socket2.on('print-response', (response) => {
            log(`Print response: ${response.message} (Status: ${response.status})`);

            Swal.close(); // Close the waiting dialog

            if (response.status === 200) {
                Swal.fire({
                    title: 'Success!',
                    text: response.message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: response.message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
        
        // Load available printers
        function loadPrinters() {
            log('üîÑ Loading available printers...');
            $.get(hostUrl + 'printers')
                .done(function(data) {
                    const select = document.getElementById('printerName');
                    select.innerHTML = '<option value="auto">Auto Detect</option>';
                    select.innerHTML += '<option value="UMUM">UMUM (Auto Detect)</option>';
                    
                    if (data.printers && data.printers.length > 0) {
                        data.printers.forEach(printer => {
                            const option = document.createElement('option');
                            option.value = printer;
                            option.textContent = printer + (printer === data.defaultPrinter ? ' (Default)' : '');
                            select.appendChild(option);
                        });
                        log(`üìÑ Found ${data.printers.length} printer(s): ${data.printers.join(', ')}`);
                        if (data.defaultPrinter) {
                            log(`üéØ Default printer: ${data.defaultPrinter}`);
                        }
                    } else {
                        log('‚ö†Ô∏è No system printers found');
                    }
                    
                    log(`üîå USB printing: ${data.usbAvailable ? 'Available' : 'Not Available'}`);
                })
                .fail(function() {
                    log('‚ùå Failed to load printers');
                });
        }
        
        // Check printer status
        function checkPrinterStatus() {
            log('üîç Checking printer status...');
            $.get(hostUrl + 'printer-status')
                .done(function(data) {
                    document.getElementById('status').innerHTML = 
                        `Status: ${data.available ? '‚úÖ Available' : '‚ùå Not Available'}<br>` +
                        `Type: ${data.type}<br>` +
                        `Printer: ${data.printer || 'None'}<br>` +
                        `Message: ${data.message}`;
                    
                    log(`üìä Printer Status - Available: ${data.available}, Type: ${data.type}, Printer: ${data.printer}`);
                })
                .fail(function() {
                    log('‚ùå Failed to check printer status');
                });
        }
        
        // Generate sample receipt data
        function generateSampleReceipt(transactionId) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('id-ID');
            const timeStr = now.toLocaleTimeString('id-ID');

            return `\x1B@\x1B!\x00TOKO DEWIANA
\x1B!\x00Jl. Raya Tajur No. 365
\x1B!\x00NO. WA 0857-777-168-69
\x1Ba\x00----------------------------------------------
NO TRX      : ${transactionId}
TGL TRX     : ${dateStr} ${timeStr}
PELANGGAN   : TEST CUSTOMER
USERNAME    : TESTUSER
----------------------------------------------
PRODUK TEST 1
     2 [PCS]   X   50.000              100.000
PRODUK TEST 2
     1 [PCS]   X   75.000               75.000
PRODUK TEST 3
     3 [PCS]   X   25.000               75.000
----------------------------------------------
JUMLAH ITEM : [3]
SUBTOTAL    : [250.000]
----------------------------------------------

              TOTAL ITEM                   [3]
               SUB TOTAL              250.000
\x1B!\x00                        \x1B!1      250.000\x1B!\x00
----------------------------------------------
TERIMAKASIH SUDAH BERBELANJA
DOWLOAD APK DEWIANA STORE DI PLAY STORE



\x1Bm`;
        }

        // Print function (standalone version without backend dependency)
        const printStruk = (idTrx, type = "true") => {
            const transactionId = idTrx || document.getElementById('transactionId').value;
            const printerType = $("#printerName").val();

            log(`üìÑ Printing receipt for transaction: ${transactionId}, printer: ${printerType}`);

            // Generate sample receipt data directly (no backend call needed)
            const receiptData = generateSampleReceipt(transactionId);

            log(`üìÑ Sample receipt data generated, sending to printer...`);

            Swal.fire({
                text: "Harap Menunggu Mencetak Struk!",
                allowOutsideClick: false,
                allowEscapeKey: false,
                icon: "info",
                buttonsStyling: false,
                showConfirmButton: false,
                customClass: {
                    confirmButton: "btn btn-primary"
                }
            });

            // Send print command via socket
            socket2.emit("print", {
                printerType: printerType,
                dataPrint: receiptData
            });
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Direct Print Test Page Loaded');
        });
    </script>
</body>
</html>